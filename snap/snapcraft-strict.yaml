# This one doesn't work x_x

name: scrcpy-buddy
version: '1.0.0'
summary: GUI wrapper for scrcpy
description: |
  A simple, clean, minimalist GUI wrapper for scrcpy (https://github.com/Genymobile/scrcpy).
grade: stable
base: core24
confinement: strict

#plugs:
#  system-binaries:
#    interface: system-files
#    read:
#      - /usr/bin/adb
#      - /usr/bin/scrcpy

apps:
  scrcpy-buddy:
    command: scrcpy_buddy
    extensions: [gnome]
    environment:
      PATH: $SNAP/lib:$SNAP/usr/lib:$SNAP/bin:$SNAP/usr/bin:$SNAP/usr/local/bin:$PATH
      LD_LIBRARY_PATH: "$LD_LIBRARY_PATH:$SNAP/usr/lib/$SNAPCRAFT_ARCH_TRIPLET:$SNAP/usr/lib/$SNAPCRAFT_ARCH_TRIPLET/android:$SNAP/usr/lib/$SNAPCRAFT_ARCH_TRIPLET/pulseaudio:/var/lib/snapd/lib/gl"
      #SCRCPY_SERVER_PATH: "$SNAP/usr/local/share/scrcpy/scrcpy-server"
      # Point to bundled binaries
      SCRCPY_BUDDY_ADB: "$SNAP/command/adb.wrapper"
      #SCRCPY_BUDDY_SCRCPY: "$SNAP/usr/local/bin/scrcpy"
    plugs:
      - adb-support
      - desktop
      - desktop-legacy
      - x11
      - unity7
      - wayland
      - opengl
      - network
      - network-bind
      - home
      - process-control
      - hardware-observe
    slots:
      - dbus-scrcpy-buddy

  # Expose scrcpy command directly
  #scrcpy:
  #  command: usr/local/bin/scrcpy
  #  environment:
  #    LD_LIBRARY_PATH: "$LD_LIBRARY_PATH:$SNAP/usr/lib/$SNAPCRAFT_ARCH_TRIPLET:$SNAP/usr/lib/$SNAPCRAFT_ARCH_TRIPLET/android:$SNAP/usr/lib/$SNAPCRAFT_ARCH_TRIPLET/pulseaudio:/var/lib/snapd/lib/gl"
  #    MESA_GLSL_CACHE_DIR: "$SNAP_USER_DATA"
  #    LIBGL_DRIVERS_PATH: "$SNAP/usr/lib/$SNAPCRAFT_ARCH_TRIPLET/dri"
  #    SCRCPY_SERVER_PATH: "$SNAP/usr/local/share/scrcpy/scrcpy-server"
  #  plugs:
  #    - adb-support
  #    - desktop
  #    - x11
  #    - wayland
  #    - opengl
  #    - network

  # Expose adb command directly
  adb:
    command: command/adb.wrapper
    environment:
      LD_LIBRARY_PATH: "$LD_LIBRARY_PATH:$SNAP/usr/lib/$SNAPCRAFT_ARCH_TRIPLET/android/"
    plugs:
      - adb-support
      - network

slots:
  dbus-scrcpy-buddy:
    interface: dbus
    bus: session
    name: dev.codertainment.scrcpy_buddy

parts:
  scrcpy-buddy:
    source: .
    plugin: flutter
    flutter-target: lib/main.dart
    override-build: |
      craftctl default
      # Create adb wrapper
      mkdir -p $CRAFT_PART_INSTALL/command
      cat > $CRAFT_PART_INSTALL/command/adb.wrapper << 'EOF'
      #!/bin/bash
      export LD_LIBRARY_PATH="$SNAP/usr/lib/x86_64-linux-gnu/android:$LD_LIBRARY_PATH"
      exec "$SNAP/usr/bin/adb" "$@"
      EOF
      chmod +x $CRAFT_PART_INSTALL/command/adb.wrapper
#    override-prime: |
#      # Clean any existing CMake cache
#      rm -rf $CRAFT_PART_BUILD/build/linux/x64/release/CMakeCache.txt
#      rm -rf $CRAFT_PART_BUILD/build/linux/x64/release/CMakeFiles
#
#      craftctl default
    stage-packages:
      - adb
      - android-sdk-platform-tools-common
      - libusb-1.0-0
      - scrcpy
    organize:
      assets/icon_light_256.png: meta/gui/icon_light.png

  #scrcpy:
  #  plugin: nil
  #  stage-snaps:
  #    - scrcpy
  #  stage:
  #    # Exclude conflicting libraries
  #    - -lib/x86_64-linux-gnu/libcom_err.so.2.1
  #    - -usr/lib/x86_64-linux-gnu/libsensors.so.4.4.0
  #    - -usr/lib/x86_64-linux-gnu/libtiff.so.5.*
  #    - -usr/lib/x86_64-linux-gnu/libxml2.so.2.*
  #    - -usr/share/doc/*/changelog.Debian.gz
